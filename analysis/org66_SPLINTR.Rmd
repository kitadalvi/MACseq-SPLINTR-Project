---
title: "ORG66 BC Analysis"
output: html_document
date: "2024-09-11"
---

```{r setup}
knitr::opts_chunk$set(echo = FALSE, warning =FALSE, message = FALSE)
```

```{r, echo=TRUE}
library(bartools)
library(Seurat)
library(SingleCellExperiment)
library(dplyr)
library(reshape2)
library(tidyr)
library(ggpubr)
library(patchwork)
```

## Loading Data
```{r, echo=TRUE}
##Loading data
counts_path <- "/Volumes/bioinf/home/ndalvi/MACseq_PMC228/results/splintr/MGC-SA-7209-full/counts/MGC-SA-7209_S1.counts.tsv"
counts <- readBartabCounts(counts_path)

#changing BC names to make them shorter
counts$barcode <- sub('SPLINTR_mCHERRY_V2_Barcode','BC',counts$barcode)
counts_agg <- aggregateBarcodes(counts)
#import metadata
metadata<-read.csv("/Volumes/bioinf/home/ndalvi/MACseq_PMC228/metadata/PMC228.csv",header=T) %>%
  arrange("Barcode") %>%
  mutate(id=gsub("Plate","",Plate_ID)) %>%
  mutate(analysis_condition=paste0(Organoid,".",Treatment_1,".",Time))

metadata<- metadata %>%
  left_join(counts_agg,by=c("Barcode"="cellid"))

```

Subsetting data for the relevant ORG line:
```{r, fig.width=10, fig.height=10}
individual_counts <- function(df, well_id){
  subset <- df[df$Well_ID==well_id,c('barcode', 'bc.umi.count')]
  subset <- separate_longer_delim(data=subset, cols=c('barcode','bc.umi.count'),delim = ';')
  subset$bc.umi.count <- as.integer(c(subset$bc.umi.count))
  names(subset)[2]<- well_id
  subset <- drop_na(subset)
  return(subset)
}

org_data <- metadata[metadata$Organoid=='ORG66' 
                   & metadata$Treatment_1 != 'STAUR' 
                   & metadata$Labelled != 'unlabelled',c('Well_ID',"Organoid","Treatment_1",'Time',"barcode", "bc.umi.count")]

rownames(org_data)<- org_data$Well_ID
treatments<- c(org_data$Well_ID)
org_data_combined <- data.frame(barcode=character())

for (well in treatments){
  df <- individual_counts(org_data, well)
  org_data_combined<- merge(org_data_combined, df, all=TRUE)
}

org_data_combined[is.na(org_data_combined)]<- 0
end <- dim(org_data_combined)[2]
barcode_data <- DGEList(counts=org_data_combined[,2:end])
rownames(barcode_data$counts)<- org_data_combined[,1]

#adding samplesheet information to DGElist object
barcode_data$samples$Sample <- org_data$Well_ID
barcode_data$samples$Treatment <- org_data$Treatment_1
barcode_data$samples$Time <- org_data$Time
barcode_data$samples$ORG <- org_data$Organoid
barcode_data <- barcode_data[rowSums(barcode_data$counts) != 0, ]

```

## Barcode Histogram 

### Entire Plate 
Visualising proportion of barcodes in all ORG66 wells across both timepoints:
```{r, fig.height=6, fig.width=10}
plotBarcodeHistogram(barcode_data, topN = 10, alphaLowFreq = 0)
```

## Proportional Bubble Plots 

### Treatment {.tabset}

#### All
Visualising proportion of Barcodes in each ORG66 well across all treatments:

```{r, fig.height=8, fig.width=10}
p1<- plotBarcodeBubble(barcode_data, 
                  proportionCutoff = 5,
                  colorDominant = TRUE,
                  labelBarcodes = T,
                  group='Treatment')

p1
```

#### Paclitaxel

Comparing proportion of barcodes after treatment with DMSO 48H VS Paclitaxel IC50 48H:
```{r, fig.height=10, fig.width=15}
p2<- plotBarcodeBubble(barcode_data[,barcode_data$samples$Time=='48H' &
                                      barcode_data$samples$Treatment=='DMSO'],
                       title="DMSO 48H",
                       colorDominant = TRUE,
                       proportionCutoff = 5,
                       labelBarcodes = T)

p3<- plotBarcodeBubble(barcode_data[,barcode_data$samples$Time=='48H' &
                                barcode_data$samples$Treatment=='Paclitaxel_IC50'],
                       title="Paclitaxel IC50 48H",
                       colorDominant = TRUE,
                       proportionCutoff = 5,
                       labelBarcodes = T)

ggarrange(p2,p3, ncol=2)
```

#### SN38

Comparing proportion of barcodes after treatment with DMSO 48H VS SN38 IC50 48H:
```{r, fig.height=10, fig.width=15}
p4<- plotBarcodeBubble(barcode_data[,barcode_data$samples$Time=='48H' &
                                      barcode_data$samples$Treatment=='DMSO'],
                       title="DMSO 48H",
                       colorDominant = TRUE,
                       proportionCutoff = 5,
                       labelBarcodes = T)

p5<- plotBarcodeBubble(barcode_data[,barcode_data$samples$Time=='48H' &
                                      barcode_data$samples$Treatment=='SN38_IC50'],
                       title="SN38 IC50 48H",
                       colorDominant = TRUE,
                       proportionCutoff = 5,
                       labelBarcodes = T)

ggarrange(p4,p5, ncol=2)
```

### Timepoint {.tabset}

#### 24H
Visualising proportion of Barcodes in each ORG66 well across all treatments at 24H:
```{r, fig.height=8, fig.width=10}
p6<- plotBarcodeBubble(barcode_data[,barcode_data$samples$Time=='24H'], 
                  proportionCutoff = 5,
                  title="All treatments 24H",
                  labelBarcodes = T,
                  colorDominant = TRUE,
                  group='Treatment')
p6
```

#### 48H
Visualising proportion of Barcodes in each ORG66 well across all treatments at 48H:
```{r, fig.height=8, fig.width=10}
p7<- plotBarcodeBubble(barcode_data[,barcode_data$samples$Time=='48H'], 
                  proportionCutoff = 5,
                  colorDominant = TRUE,
                  title="All treatments 48H",
                  labelBarcodes = T,
                  group='Treatment')
p7
```

####  Comparison
Comparing proportion of Barcodes in each ORG66 well across at 24H VS at 48H:

```{r, fig.height=10, fig.width=15}
ggarrange(p6,p7, ncol=2)
```

### IC50 48H Barcode histograms
```{r, fig.height=5, fig.width=10}
org_data <- org_data[c("H19",'H20','H21','H22','D19','D20','D21','D22','K19','K20','K21','K22'),]

treatments<- c(org_data$Well_ID)
org_data_combined <- data.frame(barcode=character())

for (well in treatments){
  df <- individual_counts(org_data, well)
  org_data_combined<- merge(org_data_combined, df, all=TRUE)
}

org_data_combined[is.na(org_data_combined)]<- 0
end <- dim(org_data_combined)[2]
barcode_data <- DGEList(counts=org_data_combined[,2:end])
rownames(barcode_data$counts)<- org_data_combined[,1]

#adding samplesheet information to DGElist object
barcode_data$samples$Sample <- org_data$Well_ID
barcode_data$samples$Treatment <- org_data$Treatment_1
barcode_data$samples$Time <- org_data$Time
barcode_data$samples$ORG <- org_data$Organoid
barcode_data <- barcode_data[rowSums(barcode_data$counts) != 0, ]

treatment <- paste(rep(c('DMSO','DMSO','DMSO','DMSO','Paclitaxel','Paclitaxel','Paclitaxel','Paclitaxel','SN38','SN38','SN38','SN38'),28))
barcode_plot <- plotBarcodeHistogram(barcode_data, topN = 10, alphaLowFreq = 0) 

data <- barcode_plot[["data"]]
data$treatment <- treatment
data <- data[order(data$barcode, decreasing = T),]
data <- data[1:120,]

plot <- ggplot(data, aes(fill=barcode, y=freq, x=sample)) + 
  geom_bar(position="stack", stat="identity", width=0.5,show.legend = FALSE) + 
  theme_light()

plot + facet_wrap(~treatment, scales='free', switch='x') + 
  xlab('Treatment') + ylab('Barcode proportion') + 
  ggtitle("Distribution of top 10 barcodes in ORG66") + 
  expand_limits(y = c(0,1)) + 
  scale_fill_manual(values=c('#6b0071','#a9c4ff','#af0406','#93c300','#0093c3','#d7ff5c','#ffa95c','#fffb5c','#ffa9ef','#ff5c60'))+
  plot_spacer() 
```
